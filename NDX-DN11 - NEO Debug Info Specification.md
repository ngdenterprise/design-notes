<!-- markdownlint-enable -->
# NDX-DN11 - NEO Debug Info Specification

- Author: Harry Pierson (harrypierson@ngd.neo.org)
- Status:
  - v1.0: Adopted
  - v1.1: Draft

## Abstract

This design note describes the debug information format used by
the [NEO Smart Contract Debugger](NDX-DN04%20-%20NEO%20Smart%20Contract%20Debugging.md).
This information will be generated by smart contract compilers
such as [NEON](https://github.com/neo-project/neo-devpack-dotnet)
or [neo-boa](https://github.com/CityOfZion/neo-boa).

## Current Status

v1.0 of the debug info format (specified below) has been implemented in v1.0 of the
[Neo Smart Contract Debugger](https://github.com/neo-project/neo-debugger)
as well as v2.6 of the 
[NEON compiler](https://github.com/neo-project/neo-devpack-dotnet/tree/master-2.x).
The Neo Smart Contract Debugger also supports the original debug info format
(described below) that was generated by a fork of the NEON compiler that is no
longer supported.

[neo-boa](https://github.com/CityOfZion/neo-boa) and
[neo-go](https://github.com/nspcc-dev/neo-go) both now support v1.0 of the debug
info format.

### Neo 3 support

v1.1 of the debug info format (specified below) will be used by the Neo 3 versions
of the Neo Smart Contract Debugger as well as Neo smart contract compilers (NEON,
neo-boa and neo-go).

## Original Format

> Note, this format and the NEON-DE compiler fork are obsolete. v1.0 of this format
  (described below) is the adopted version of this format for Neo 2 compilers/debuggers.
  v1.1 of this format (also described below) is the draft version of this format
  for Neo 3 compilers/debuggers.

The NEON-DE compiler fork emitted debug info in a json file with the extension
.debug.json. This document contained the following types:

> Note, these types are defined in TypeScript for readability.
> There is no requirement that this format be implemented in TypeScript.

``` typescript
interface DebugInformatiom {
    entrypoint: string;
    methods: Method[];
    events: Event[];
    sequence-points: SequencePoint[]; // unused, to be removed
}

interface Method {
    name: string;
    namespace: string;
    display-name: string;
    start-address: number;
    end-address: number;
    parameters: Variable[];
    return-type: string;
    variables: Variable[];
    sequence-points: SequencePoint[];
}

interface Variable {
    name: string;
    type: string;
}

interface Event {
    name: string;
    namespace: string;
    display-name: string;
    parameters: Variable[];
    return-type: string;
}

interface SequencePoint {
    address: number;
    document: string;
    start-line: number;
    start-column: number;
    end-line: number;
    end-column: number;
}
```

A debug info document is primarily an array of Method objects. Each opcode
in a compiled NeoVM script is associated with exactly one Method object in
the debug info. Each Method object has a start and end address than cannot
overlap with any other Method object in the debug info. The Method for a
given address is determined by searching the non-overlapping list of method
address ranges for the single Method the opcode address belongs to.

In addition to the address range, a Method object contains the following
information:

- Display information about the Method, such as `name`, `namespace` and
  `display-name`. The `display-name` field is used to identify the Method
  in the call stack view of the debugger.
- Type information about parameters, variables and return variables.
  The type information is used to format the memory associated with type
  for human consumption in the debugger. Parameters and variables also
  have a name that is displayed in the debugger, allowing the developer
  to associate individual types in the variable window to variables
  in their code.
- Sequence points map individual NeoVM opcode addresses to a sequence
  of text in a source file. Because of the nature of mapping high level
  source code to low level opcodes, there will not be a sequence point
  for every address in the NeoVM script file.

> Note, the `sequence-points` property of the root debug info object
> is not used by the NEO smart contract debugger and will be removed
> from the NEON compiler in a future release.

Debug info can also contain an array of Event objects. Event objects have
parameter and return types like a Method, but have no implementation
details such as variables, sequence points or start/end addresses.

## v1.0 Format

> Note, when v1.0 of this specification was first published it was out of
  sync with the implementation in NEON and the Neo Smart Contract Debugger.
  In particular, the changes to rename `parameters` to `params` and `return-type`
  to `return` were missing.

The format described above contains a lot of redundant and/or unused data.
Additionally, some data could be encoded in a more size sensitive manner.
In v1.0, the following changes are being made to the debug info format:

- Compress the `<contract>.debug.json` file into a zip file with a
  `.avmdbgnfo` extension
- Removed top level `sequence-points` property since it was
  not being used.
- Added a top level `documents` property that contains an array of
  unique file paths.
- Renamed method/event `name` property to `id`
- Renamed method/event `parameters` property to `params`
- Renamed method `return-type` property to `return`
- Encode namespace and name in method/event `name` property
- Encode method start/end address in `range` property
- Encode parameter/variable name and type in single string value
- Encode sequence point information in single string value
- Removed event `return-type` property as the compiler now enforces
  events as being void return.

In addition to the TypeScript based description below, we have published
a separate [JSON Schema](https://json-schema.org/) version of this format:
[neo-debug-info-schema.v1.json](neo-debug-info-schema.v1.json).

``` typescript
interface DebugInformatiom {
    entrypoint: string;
    documents: string[];
    methods: Method[];
    events: Event[];
}

interface Method {
    id: string;
    name: string; // format: "{namespace},{display-name}
    range: string; // format: "{start-address}-{end-address}
    params: string[]; // format: "{name},{type}
    return: string;
    variables: string[]; // format: "{name},{type}
    sequence-points: string[]; // format: "{address}[{document-index}]{start-line}:{start-column}-{end-line}:{end-column}"
}

interface Event {
    id: string; // previously "name"
    name: string; // format: "{namespace}-{display-name}
    params: string[]; // format: "{name},{type}
}
```

## v1.1 Format

In v1.1, the following changes are being made to the debug info format
to accommodate changes related to Neo 3.

- added top level `hash` property containing the scriptHash for the
  associated contract
  - For Neo 2 contract debug info, hash property is optional
  - For Neo 3 contract debug info, hash property is required
- made top level `entrypoint` property optional
  - For Neo 2 contract debug info, hash property is required
  - For Neo 3 contract debug info, hash property is not used
- Compressed Neo 3 contract debug info files will use `.nefdbgnfo`
  for their extension. Compressed Neo 2 contract debug info files 
  will continue to use the `.avmdbgnfo` extension

In addition to the TypeScript based description below, we have published
a separate [JSON Schema](https://json-schema.org/) version of this format:
[neo-debug-info-schema.v1.1.json](neo-debug-info-schema.v1.1.json).

``` typescript
interface DebugInformatiom {
    hash?: string;
    entrypoint?: string;
    documents: string[];
    methods: Method[];
    events: Event[];
}

interface Method {
    id: string;
    name: string; // format: "{namespace},{display-name}
    range: string; // format: "{start-address}-{end-address}
    params: string[]; // format: "{name},{type}
    return: string;
    variables: string[]; // format: "{name},{type}
    sequence-points: string[]; // format: "{address}[{document-index}]{start-line}:{start-column}-{end-line}:{end-column}"
}

interface Event {
    id: string; // previously "name"
    name: string; // format: "{namespace}-{display-name}
    params: string[]; // format: "{name},{type}
}
```
