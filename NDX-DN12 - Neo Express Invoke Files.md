<!-- markdownlint-enable -->
# NDX-DN12 - Neo Express Contract Invoke File Specification

- Author: Harry Pierson (harrypierson@ngd.neo.org)
- Status: Draft

## Abstract

This design note describes the contract invocation file format used by v2 of
[neo-express](https://github.com/neo-project/neo-express) (unreleased).

## Current Status

neo-express insiders branch (unreleased v2.0) supports the format described in this
note for the `contract invoke` command. As of right now, contract invocation files
must be written by hand, but we expect a future version of
[Visual DevTracker](https://github.com/neo-project/neo-visual-tracker)
to provide a visual design experience.

## Overview

In neo-express v1.x, the `contract invoke` command accepted contract parameter information
on the command line. This turned out to be unwieldy for anything but the simplest
contract signatures.

For v2.0 and beyond, neo-express will be using a JSON file containing contract
invocation information. This file will be passed by path to the `contract invoke`
neo-express command. This document describes the initial format of Neo contract
invoke files. Additionally, this repo contains a [JSON Schema](./neo-invoke-schema.json)
file that can be used to validate contract invoke files.

> Note, this format is in draft and will likely evolve as we get closer to the neo-express
  v2.0 release.

There are several advantages of using a invoke file instead of the command line:

- invoke files can be checked into source control
- invoke files can handle arbitrarily complex sets of arguments, including UTXO information
- invoke files can be generated by tools such as Visual DevTracker

## neo-invoke File Format

A neo-invoke file is a serialized JSON object that contains the information needed
to invoke a Neo smart contract. The file can have any extension, though it typically
uses `.neo-invoke.json` to both indicate its usage as well as enable JSON syntax
highlighting in tools.

> Note, what follows is a non-normative description of the neo-invoke JSON format.
> For a normative specification of the format, please see the [JSON Schema file](neo-invoke-schema.json)

A neo-invoke JSON object has three properties: `contract`, `operation` and `args`.
Of the three, only `contract` is required as per the JSON Schema. However, for invoke
files intended to be used with Neo 3, the `operation` property is required.

### `contract` Property

The `contract` property contains information about what contract to invoke. This
property is a JSON object with one of two mutually exclusive properties:

- `hash` is the hex-encoded script hash of the contract to invoke. The format expected
  matches the top level `hash` property of the .abi.json file generated by the
  [NEON compiler](https://github.com/neo-project/neo-devpack-dotnet).
- `path` is an absolute or relative path to the compiled contract binary (.avm for
  Neo 2, .nef for Neo 3). The script hash of the contract will be calculated at run
  time by neo-express.

### `operation` Property

In Neo 2, contracts have a single `Main` entry point method. It is common for this
method to accept two parameters: a string and an object array. The string specifies
the operation to execute (for example, [NEP-5](https://github.com/neo-project/proposals/blob/master/nep-5.mediawiki)
specifies method names such as `balanceOf` and `transfer`) while the object array
contains the arguments to be passed to the operation being invoked.

Neo 3 has eliminated the single contract entrypoint and codified the name/arguments
pattern. As such, for Neo 3 contracts, the operation to be invoked must be specified
by name in the contract invoke file.

The `operation` property is ignored when invoking Neo 2 contracts.

### `args` Property

The `args` property contains an array of contract parameters to be passed to the
contact via the invoke script. neo-express generates the invoke script for the
contract specified via the `contract` property (and for the `operation` specified
in the case of Neo 3).

The core neo ContractParameter type's
[FromJson method](https://github.com/neo-project/neo/blob/master-2.x/neo/SmartContract/ContractParameter.cs#L58)
expects a contract parameters to be encoded like this:

> Note, these types are defined in TypeScript for readability.
> There is no requirement that this format be implemented in TypeScript.

``` typescript
// InteropInterface and Void ContractParameterTypes can not be specified in JSON
enum ContractParameterType {
    "Boolean",
    "Integer",
    "ByteArray",
    "String",
    "Hash160",
    "Hash256",
    "PublicKey",
    "Signature",
    "Array",
    "Map"
}

interface ContractParameter {
    type: ContractParameterType,
    value: boolean | string | ContractParameter[] | {key: ContractParameter, value: ContractParameter}[]
}
```

The specifics of the JSON encoded value field vary by parameter type:

- Boolean parameter values encoded as JSON boolean
- String parameter values encoded as JSON string
- Signature and ByteArray parameter values are encoded as a hex-encoded JSON string
- Integer, Hash160/256, Public Key are encoded as serialized JSON string of the
  corresponding type (BigInteger, UInt160/256, ECPoint)
- Array parameters are encoded as JSON array of encoded contract parameters
- Map parameter are encoded as a JSON array of objects, each with a "key" and
  "value" property containing an encoded contract parameter

While this encoding is complete and deterministic, it is also verbose. For example,
here is the an example neo-invoke file for invoking the register operation of the
[Neo 2 Domain Smart Contract example](https://github.com/ngdseattle/domain-sample)
using the standard contract parameter encoding:

``` json
{
    "contract": { "hash": "0xc0dee90a1ce8fbb94169608907e5986a6ce909e7" },
    "args": [
        {
            "type": "String",
            "value": "register"
        },
        {
            "type": "Array",
            "value": [
                {
                    "type": "String",
                    "value": "neo.org"
                },
                {
                    "type": "Hash160",
                    "value": "7f513a2129dd800e1db8c2a57bc0873a021c9b7f"
                }
            ]
        }
    ]
}
```

To reduce verbosity and provide a better experience for developers that have to
author contract parameter JSON by hand, neo-express uses additional, compact
encodings of Contract Parameters.

In cases where there is a direct correlation of JSON type to Contract Parameter
type, the JSON type can be used directly instead of the more verbose type qualified
format. The following JSON types are treated as the corresponding Contract parameter
type:

- Boolean
- Integer
  - Note, non-integer JSON numbers are not valid contract parameters. Additionally,
    only integers that fall between
    [`Number.MIN_SAFE_INTEGER`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/MIN_SAFE_INTEGER)
    and [`Number.MAX_SAFE_INTEGER`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/MAX_SAFE_INTEGER)
    can be encoded in this manner. Integers that fall outside that range should be
    encoded using the type/value approach detailed above.
- String
- Array

Additionally, direct encoded strings can use special prefixes to indicate other contract
parameter types

- Direct encoded strings with a '0x' prefix are treated as a hex encoded ByteArray
- Direct encoded strings with a '@A' prefix are treated as a base68 encoded Hash160
  value (i.e. Neo wallet addresses)
  - For Neo v3, the prefix will be '@N'

These additional encodings significantly simplify the sample invoke file from above:

``` json
{
    "contract": { "hash": "0xc0dee90a1ce8fbb94169608907e5986a6ce909e7" },
    "args": [
        "register",                               // direct encoded string
        [                                         // direct encoded array
            "neo.org",
            "@ANxbzd4FuNr1BBMJX2ZixSzFKFWeFCReAb" // base56 encoded Hash160
        ]
    ]
}
```
